#!/usr/bin/env bash

export BITWARDENCLI_APPDATA_DIR=~/.config/bw-w
export BW_CLIENTID=$BW_CLIENTID_WORK
export BW_CLIENTSECRET=$BW_CLIENTSECRET_WORK
export BW_MP=$BW_MP_WORK

PLATFORM="unknown"
if command -v apt; then
   PLATFORM='ubuntu'
fi
if command -v brew; then
   PLATFORM='mac'
fi
if command -v pacman
then
   PLATFORM='arch'
fi

install_package () {
  if [[ "$PLATFORM" == "ubuntu" ]]; then
    sudo apt-get -qq -o "DPkg::Lock::Timeout=180" install $1
  fi
  if [[ "$PLATFORM" == "mac" ]]; then
    brew install -q $1 
  fi
  if [[ "$PLATFORM" == "arch" ]]; then
    sudo pacman -Syu --noconfirm $1
  fi
}

remove_package () {
  if [[ "$PLATFORM" == "ubuntu" ]]; then
    sudo apt-get -qq -o "DPkg::Lock::Timeout=180" remove $1
  fi
  if [[ "$PLATFORM" == "mac" ]]; then
    brew uninstall -q $1
  fi
  if [[ "$PLATFORM" == "arch" ]]; then
    sudo pacman -Rsc $1
  fi
}

update_packages () {
  if [[ "$PLATFORM" == "ubuntu" ]]; then
    sudo apt-get -qq -o "DPkg::Lock::Timeout=180" update > /dev/null
  fi
  if [[ "$PLATFORM" == "mac" ]]; then
    brew update -q
  fi
  if [[ "$PLATFORM" == "arch" ]]; then
    sudo pacman -Syu
    pacman -Rns $(pacman -Qdtq)	
  fi
}

upgrade_packages () {
  if [[ "$PLATFORM" == "ubuntu" ]]; then
    sudo -E apt-get -qq -o "Dpkg::Options::=--force-confdef" -o "Dpkg::Options::=--force-confold" -o "DPkg::Lock::Timeout=180" upgrade > /dev/null
  fi
  if [[ "$PLATFORM" == "mac" ]]; then
    brew upgrade -q
  fi
  if [[ "$PLATFORM" == "arch" ]]; then
    sudo pacman -Syu
    pacman -Rns $(pacman -Qdtq)	
  fi
}

install_bitwarden () {
  if ! command -v unzip
  then
    install_package unzip
  fi

  if [[ "$PLATFORM" == "ubuntu" || "$PLATFORM" == "arch" ]]; then
    curl -s --location "https://vault.bitwarden.com/download/?app=cli&platform=linux" --output bw.zip
    unzip bw.zip -d . 
    chmod +x bw
    sudo mv bw /usr/local/bin
    rm bw.zip
  fi

  if [[ "$PLATFORM" == "mac" ]]; then
    curl -s --location "https://vault.bitwarden.com/download/?app=cli&platform=macos" --output bw.zip
    unzip bw.zip -d . 
    chmod +x bw
    sudo mkdir -p /usr/local/bin
    sudo mv bw /usr/local/bin
    rm bw.zip
  fi
}

login_to_bw () {
  bw logout
  export BW_SESSION="$(bw login --raw)"
  bw sync
}

find_config_in_vault () {
  echo $(bw list items --search "bitwarden-environment-setup" --collectionid 'null' --session $BW_SESSION)
}

parse_config_item () {
  echo $(find_config_in_vault) | python3 -c "import sys, json; print(json.load(sys.stdin)[0]${1})"
}

parse_config_item_custom_field () {
  echo $(find_config_in_vault) | python3 -c "import sys, json; print(next(cf for cf in json.load(sys.stdin)[0]['fields'] if cf['name'] == '${1}')['value'])"
}

generate_passphrase () {
  echo $(bw generate --passphrase --words 3 -c --includeNumber --separator ! --session $BW_SESSION)
}

if ! command -v bw
then
  install_bitwarden
fi
